name: CI - Quality Gates

on:
  push:
    branches: [ main, develop, 'stabilization/*', 'feature/*' ]
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

env:
  NODE_VERSION: '20'
  DATABASE_URL: 'postgresql://test:test@localhost:5432/test'
  SESSION_SECRET: 'test-secret-for-ci-only'

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Quality Checks - MUST PASS (runs in parallel)
  quality:
    name: Code Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: TypeScript - Strict Type Check
        run: |
          echo "üîç Running TypeScript strict mode checks..."
          npm run typecheck
        continue-on-error: false  # MUST PASS

      - name: ESLint - Code Quality & Architecture
        run: |
          echo "üìê Checking code quality and architectural boundaries..."
          npm run lint
        continue-on-error: false  # MUST PASS

      - name: Prettier - Code Formatting
        run: |
          echo "üé® Checking code formatting..."
          npm run format
        continue-on-error: false  # MUST PASS

      - name: Check for 'any' types in new modules
        run: |
          echo "üö´ Checking for forbidden 'any' types in new module architecture..."
          any_found=false

          # Check src/modules/ (new architecture - zero tolerance)
          if [ -d "src/modules" ]; then
            if grep -r ": any\|<any>\|any\[\]\|Array<any>\|Record<.*any" \
              --include="*.ts" --include="*.tsx" \
              --exclude="*.test.ts" --exclude="*.spec.ts" \
              src/modules/ 2>/dev/null; then
              echo "‚ùå Found 'any' types in src/modules/ - ZERO TOLERANCE in new architecture!"
              any_found=true
            fi
          fi

          # Check src/core/ (new architecture - zero tolerance)
          if [ -d "src/core" ]; then
            if grep -r ": any\|<any>\|any\[\]\|Array<any>\|Record<.*any" \
              --include="*.ts" --include="*.tsx" \
              --exclude="*.test.ts" --exclude="*.spec.ts" \
              src/core/ 2>/dev/null; then
              echo "‚ùå Found 'any' types in src/core/ - ZERO TOLERANCE in new architecture!"
              any_found=true
            fi
          fi

          # Check shared/models/ (canonical models - zero tolerance)
          if [ -d "shared/models" ]; then
            if grep -r ": any\|<any>\|any\[\]\|Array<any>\|Record<.*any" \
              --include="*.ts" \
              shared/models/ 2>/dev/null; then
              echo "‚ùå Found 'any' types in shared/models/ - canonical models must be strictly typed!"
              any_found=true
            fi
          fi

          if [ "$any_found" = true ]; then
            exit 1
          fi

          echo "‚úÖ No 'any' types in new architecture (src/modules/, src/core/, shared/models/)"
        continue-on-error: false  # MUST PASS

      - name: Module Boundary Check
        run: |
          echo "üèõÔ∏è Checking module boundaries..."
          boundary_violation=false

          # Check for illegal cross-module imports (e.g., importing from another module's internals)
          if [ -d "src/modules" ]; then
            # Pattern: importing from another module's internal files (not index.ts)
            # Example violation: import { X } from 'src/modules/auth/services/auth.service'
            # Should be: import { X } from 'src/modules/auth'

            while IFS= read -r file; do
              # Check each TypeScript file in modules
              if grep -E "from ['\"].*\/modules\/[^'\"\/]+\/[^'\"]+['\"]" "$file" 2>/dev/null | \
                 grep -v "from ['\"].*\/modules\/[^'\"\/]+['\"]" | \
                 grep -v "from ['\"]\.\/"; then
                echo "‚ùå Found illegal cross-module import in: $file"
                echo "   Modules can only import from other modules' index.ts (public API)"
                boundary_violation=true
              fi
            done < <(find src/modules -name "*.ts" -o -name "*.tsx" 2>/dev/null)
          fi

          if [ "$boundary_violation" = true ]; then
            exit 1
          fi

          echo "‚úÖ Module boundaries respected"
        continue-on-error: false  # MUST PASS

  # Job 2: Build Verification (runs after quality passes)
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quality  # Only run if quality passes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build application
        run: |
          echo "üî® Building application..."
          npm run build
        continue-on-error: false  # MUST PASS

      - name: Check build output
        run: |
          echo "üì¶ Verifying build artifacts..."

          # Check client build (Vite)
          if [ ! -d "dist" ]; then
            echo "‚ùå Client build failed - no dist/ directory!"
            exit 1
          fi

          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Client build failed - no index.html in dist/!"
            exit 1
          fi

          # Check server build (esbuild)
          if [ ! -f "dist/index.js" ]; then
            echo "‚ùå Server build failed - no dist/index.js!"
            exit 1
          fi

          echo "‚úÖ Build successful!"
          echo "Client bundle size:"
          du -sh dist/
          echo ""
          echo "Top 5 largest client assets:"
          find dist/assets -type f -exec du -h {} + 2>/dev/null | sort -rh | head -5 || echo "No assets found"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # Job 3: Test Suite (runs in parallel with build after quality passes)
  tests:
    name: Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quality  # Only run if quality passes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run tests
        run: |
          echo "üß™ Running test suite..."
          npm run test || {
            echo "‚ö†Ô∏è Tests failed or no tests found"
            # For now, don't fail CI if tests fail (during migration)
            # Remove this once test suite is stable
            exit 0
          }
        continue-on-error: true  # Don't block during migration period

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # Job 4: Security Scan (runs in parallel with build/tests)
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run security audit
        run: |
          echo "üîí Running security audit..."
          npm audit --audit-level=high || {
            echo "‚ö†Ô∏è Security vulnerabilities found (high severity or above)"
            echo "Run 'npm audit' locally to see details"
            # Don't fail CI for now - just warn
            exit 0
          }

      - name: Check for secrets in code
        run: |
          echo "üîë Checking for exposed secrets..."
          secrets_found=false

          # Check for OpenAI API keys
          if grep -rE "sk-[a-zA-Z0-9]{48}" --include="*.ts" --include="*.tsx" --include="*.js" . 2>/dev/null | grep -v node_modules; then
            echo "‚ùå Potential OpenAI API key found in source code!"
            secrets_found=true
          fi

          # Check for hardcoded passwords
          if grep -rE "password['\"]?\s*[:=]\s*['\"][^'\"]{8,}['\"]" --include="*.ts" --include="*.tsx" --include="*.js" client/ server/ shared/ src/ 2>/dev/null; then
            echo "‚ö†Ô∏è Potential hardcoded password found!"
            # This is a warning, not a failure (might be test data)
          fi

          # Check for AWS keys
          if grep -rE "AKIA[0-9A-Z]{16}" --include="*.ts" --include="*.tsx" --include="*.js" . 2>/dev/null | grep -v node_modules; then
            echo "‚ùå Potential AWS access key found in source code!"
            secrets_found=true
          fi

          if [ "$secrets_found" = true ]; then
            echo "‚ùå Secrets detected in code - do not commit API keys!"
            exit 1
          fi

          echo "‚úÖ No secrets detected in source code"
        continue-on-error: false  # MUST PASS

  # Job 5: Database Migration Check (runs in parallel)
  database:
    name: Database Migration Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Check migrations
        run: |
          echo "üìä Checking database migrations..."
          if [ -d "migrations" ]; then
            migration_count=$(find migrations -name "*.sql" 2>/dev/null | wc -l)
            echo "Found $migration_count migration files"

            # Verify migration naming convention (NNNN_description.sql)
            naming_violations=false
            for file in migrations/*.sql 2>/dev/null; do
              basename_file=$(basename "$file")
              if [[ ! "$basename_file" =~ ^[0-9]{3,4}_.+\.sql$ ]]; then
                echo "‚ùå Migration file $file doesn't follow naming convention (NNNN_description.sql)"
                naming_violations=true
              fi
            done

            if [ "$naming_violations" = true ]; then
              exit 1
            fi

            echo "‚úÖ All migrations follow naming convention"

            # Check for potential migration conflicts
            echo ""
            echo "Migration files (in order):"
            ls -1 migrations/*.sql 2>/dev/null | sort
          else
            echo "‚ö†Ô∏è No migrations directory found"
          fi

  # Job 6: Performance & Bundle Size Check
  performance:
    name: Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality, build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: Bundle size check
        run: |
          echo "üìè Checking bundle size..."
          echo ""
          echo "Total dist size:"
          du -sh dist/
          echo ""
          echo "Asset breakdown:"
          du -sh dist/assets/ 2>/dev/null || echo "No assets directory"
          echo ""
          echo "Top 10 largest assets:"
          find dist/assets -type f -exec du -h {} + 2>/dev/null | sort -rh | head -10 || echo "No assets found"

          # Check for oversized chunks (warning only)
          echo ""
          echo "Checking for large JavaScript chunks (>500KB)..."
          large_files=$(find dist/assets -name "*.js" -type f -size +500k 2>/dev/null)
          if [ ! -z "$large_files" ]; then
            echo "‚ö†Ô∏è Warning: Large JavaScript chunks detected:"
            du -h $large_files
            echo ""
            echo "Consider code splitting or lazy loading for these large chunks"
          else
            echo "‚úÖ No oversized JavaScript chunks"
          fi

  # Final Job: All Gates Passed
  all-checks:
    name: ‚úÖ All Quality Gates
    runs-on: ubuntu-latest
    needs: [quality, build, tests, security, database, performance]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "üìä CI Pipeline Summary"
          echo "====================="
          echo ""

          # Check critical jobs
          if [ "${{ needs.quality.result }}" != "success" ]; then
            echo "‚ùå Quality checks failed!"
            echo "   - Fix TypeScript errors, ESLint violations, or formatting issues"
            exit 1
          fi

          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå Build verification failed!"
            echo "   - Fix build errors before merging"
            exit 1
          fi

          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "‚ùå Security scan failed!"
            echo "   - Remove secrets from code or fix security issues"
            exit 1
          fi

          # Check non-critical jobs (warnings only)
          if [ "${{ needs.tests.result }}" != "success" ]; then
            echo "‚ö†Ô∏è  Tests failed (non-blocking during migration)"
          fi

          if [ "${{ needs.database.result }}" != "success" ]; then
            echo "‚ö†Ô∏è  Database migration check failed (non-blocking)"
          fi

          if [ "${{ needs.performance.result }}" != "success" ]; then
            echo "‚ö†Ô∏è  Performance check failed (non-blocking)"
          fi

          echo ""
          echo "‚úÖ All critical quality gates passed!"
          echo ""
          echo "üìã Checks completed:"
          echo "  ‚úÖ TypeScript strict mode"
          echo "  ‚úÖ ESLint (code quality + architecture)"
          echo "  ‚úÖ Prettier (code formatting)"
          echo "  ‚úÖ No 'any' types in new modules"
          echo "  ‚úÖ Module boundaries enforced"
          echo "  ‚úÖ Build successful"
          echo "  ‚úÖ No secrets in code"
          echo "  ‚ö†Ô∏è  Tests: ${{ needs.tests.result }}"
          echo "  ‚ö†Ô∏è  Database: ${{ needs.database.result }}"
          echo "  ‚ö†Ô∏è  Performance: ${{ needs.performance.result }}"
          echo ""
          echo "üöÄ Code is ready to merge!"

# ==============================================================================
# BRANCH PROTECTION SETUP INSTRUCTIONS
# ==============================================================================
#
# Configure these settings in GitHub repository settings:
#
# Settings > Branches > Add branch protection rule for 'main':
#
# 1. ‚úÖ Require pull request reviews before merging
#    - Required approving reviews: 1
#
# 2. ‚úÖ Require status checks to pass before merging
#    - Require branches to be up to date before merging: ‚úÖ
#    - Required status checks:
#      - quality (CRITICAL)
#      - build (CRITICAL)
#      - security (CRITICAL)
#      - all-checks (CRITICAL)
#
# 3. ‚úÖ Require conversation resolution before merging
#
# 4. ‚úÖ Include administrators (no one can bypass)
#
# 5. ‚úÖ Do not allow bypassing the above settings
#
# ==============================================================================
