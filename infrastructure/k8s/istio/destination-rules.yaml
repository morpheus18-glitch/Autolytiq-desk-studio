# DestinationRules for TLS Settings, Connection Pools, and Circuit Breakers
# These rules configure how traffic is handled for each service
---
# API Gateway Destination Rule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: api-gateway
  namespace: autolytiq
spec:
  host: api-gateway.autolytiq.svc.cluster.local
  trafficPolicy:
    # TLS Settings - ISTIO_MUTUAL for automatic mTLS
    tls:
      mode: ISTIO_MUTUAL

    # Connection Pool Settings
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
        tcpKeepalive:
          time: 7200s
          interval: 75s
          probes: 10
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 100
        maxRetries: 3
        idleTimeout: 60s

    # Circuit Breaker / Outlier Detection
    outlierDetection:
      consecutive5xxErrors: 5
      consecutiveGatewayErrors: 5
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30
      splitExternalLocalOriginErrors: true
      consecutiveLocalOriginFailures: 5

    # Load Balancing
    loadBalancer:
      simple: LEAST_REQUEST
      localityLbSetting:
        enabled: true
        failover:
          - from: us-east-1
            to: us-west-2

  # Subset definitions for canary deployments
  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary
---
# Auth Service Destination Rule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: auth-service
  namespace: autolytiq
spec:
  host: auth-service.autolytiq.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

    connectionPool:
      tcp:
        maxConnections: 50
        connectTimeout: 5s
        tcpKeepalive:
          time: 7200s
          interval: 75s
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 50
        http2MaxRequests: 500
        maxRequestsPerConnection: 50
        maxRetries: 3
        idleTimeout: 60s

    outlierDetection:
      consecutive5xxErrors: 3
      consecutiveGatewayErrors: 3
      interval: 5s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30

    loadBalancer:
      simple: ROUND_ROBIN

  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary
---
# Deal Service Destination Rule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: deal-service
  namespace: autolytiq
spec:
  host: deal-service.autolytiq.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
        tcpKeepalive:
          time: 7200s
          interval: 75s
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 100
        maxRetries: 3
        idleTimeout: 120s

    outlierDetection:
      consecutive5xxErrors: 5
      consecutiveGatewayErrors: 5
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30

    loadBalancer:
      simple: LEAST_REQUEST

  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary
---
# Customer Service Destination Rule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: customer-service
  namespace: autolytiq
spec:
  host: customer-service.autolytiq.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
        tcpKeepalive:
          time: 7200s
          interval: 75s
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 100
        maxRetries: 3
        idleTimeout: 60s

    outlierDetection:
      consecutive5xxErrors: 5
      consecutiveGatewayErrors: 5
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30

    loadBalancer:
      simple: ROUND_ROBIN

  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary
---
# Inventory Service Destination Rule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: inventory-service
  namespace: autolytiq
spec:
  host: inventory-service.autolytiq.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
        tcpKeepalive:
          time: 7200s
          interval: 75s
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 100
        maxRetries: 3
        idleTimeout: 60s

    outlierDetection:
      consecutive5xxErrors: 5
      consecutiveGatewayErrors: 5
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30

    loadBalancer:
      simple: ROUND_ROBIN

  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary
---
# Email Service Destination Rule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: email-service
  namespace: autolytiq
spec:
  host: email-service.autolytiq.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

    connectionPool:
      tcp:
        maxConnections: 50
        connectTimeout: 30s
        tcpKeepalive:
          time: 7200s
          interval: 75s
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 50
        http2MaxRequests: 200
        maxRequestsPerConnection: 20
        maxRetries: 3
        idleTimeout: 60s

    outlierDetection:
      consecutive5xxErrors: 3
      consecutiveGatewayErrors: 3
      interval: 30s
      baseEjectionTime: 60s
      maxEjectionPercent: 50
      minHealthPercent: 0

    loadBalancer:
      simple: ROUND_ROBIN

  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary
---
# User Service Destination Rule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: user-service
  namespace: autolytiq
spec:
  host: user-service.autolytiq.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

    connectionPool:
      tcp:
        maxConnections: 50
        connectTimeout: 5s
        tcpKeepalive:
          time: 7200s
          interval: 75s
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 50
        http2MaxRequests: 500
        maxRequestsPerConnection: 50
        maxRetries: 3
        idleTimeout: 60s

    outlierDetection:
      consecutive5xxErrors: 5
      consecutiveGatewayErrors: 5
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30

    loadBalancer:
      simple: ROUND_ROBIN

  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary
---
# Config Service Destination Rule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: config-service
  namespace: autolytiq
spec:
  host: config-service.autolytiq.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

    connectionPool:
      tcp:
        maxConnections: 50
        connectTimeout: 5s
        tcpKeepalive:
          time: 7200s
          interval: 75s
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 50
        http2MaxRequests: 500
        maxRequestsPerConnection: 100
        maxRetries: 3
        idleTimeout: 300s

    outlierDetection:
      consecutive5xxErrors: 3
      consecutiveGatewayErrors: 3
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30

    loadBalancer:
      simple: ROUND_ROBIN

  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary
---
# PostgreSQL Destination Rule
# Database connections need special handling
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: postgres
  namespace: autolytiq
spec:
  host: postgres.autolytiq.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

    connectionPool:
      tcp:
        maxConnections: 200
        connectTimeout: 30s
        tcpKeepalive:
          time: 7200s
          interval: 75s

    outlierDetection:
      consecutive5xxErrors: 3
      interval: 30s
      baseEjectionTime: 60s
      maxEjectionPercent: 100
      minHealthPercent: 0
---
# Redis Destination Rule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: redis
  namespace: autolytiq
spec:
  host: redis.autolytiq.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

    connectionPool:
      tcp:
        maxConnections: 500
        connectTimeout: 5s
        tcpKeepalive:
          time: 7200s
          interval: 75s

    outlierDetection:
      consecutive5xxErrors: 3
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 0
---
# Global default destination rule for external services
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: default-external
  namespace: autolytiq
spec:
  host: '*.external.svc.cluster.local'
  trafficPolicy:
    tls:
      mode: SIMPLE

    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 30s
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRetries: 3
        idleTimeout: 60s

    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 60s
      maxEjectionPercent: 50
