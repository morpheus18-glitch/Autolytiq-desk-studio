---
# =============================================================================
# External Secrets for Autolytiq Services
# =============================================================================
# These ExternalSecret resources fetch secrets from AWS Secrets Manager
# and create Kubernetes Secrets that can be mounted by pods
# =============================================================================

# -----------------------------------------------------------------------------
# Database Credentials
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: autolytiq
  labels:
    app.kubernetes.io/name: database-credentials
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: database-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: database-credentials
      data:
        DATABASE_URL: '{{ .url }}'
        POSTGRES_USER: '{{ .username }}'
        POSTGRES_PASSWORD: '{{ .password }}'
        POSTGRES_HOST: '{{ .host }}'
        POSTGRES_PORT: '{{ .port }}'
        POSTGRES_DB: '{{ .database }}'
  data:
    - secretKey: url
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/database
        property: url
    - secretKey: username
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/database
        property: username
    - secretKey: password
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/database
        property: password
    - secretKey: host
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/database
        property: host
    - secretKey: port
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/database
        property: port
    - secretKey: database
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/database
        property: database
---
# -----------------------------------------------------------------------------
# Redis Credentials
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-credentials
  namespace: autolytiq
  labels:
    app.kubernetes.io/name: redis-credentials
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: redis-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        REDIS_URL: '{{ .url }}'
        REDIS_HOST: '{{ .host }}'
        REDIS_PASSWORD: '{{ .password }}'
  data:
    - secretKey: url
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/redis
        property: url
    - secretKey: host
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/redis
        property: host
    - secretKey: password
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/redis
        property: password
---
# -----------------------------------------------------------------------------
# JWT Authentication Secrets
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-secrets
  namespace: autolytiq
  labels:
    app.kubernetes.io/name: jwt-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: jwt-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        JWT_SECRET: '{{ .secret }}'
        JWT_ISSUER: '{{ .issuer }}'
  data:
    - secretKey: secret
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/jwt
        property: secret
    - secretKey: issuer
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/jwt
        property: issuer
---
# -----------------------------------------------------------------------------
# PII Encryption Key
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pii-encryption-secrets
  namespace: autolytiq
  labels:
    app.kubernetes.io/name: pii-encryption-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: pii-encryption-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        PII_ENCRYPTION_KEY: '{{ .key }}'
        PII_ENCRYPTION_VERSION: '{{ .version }}'
  data:
    - secretKey: key
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/pii-encryption
        property: key
    - secretKey: version
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/pii-encryption
        property: version
---
# -----------------------------------------------------------------------------
# Session Secret
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: session-secrets
  namespace: autolytiq
  labels:
    app.kubernetes.io/name: session-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: session-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        SESSION_SECRET: '{{ .secret }}'
  data:
    - secretKey: secret
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/session
        property: secret
---
# -----------------------------------------------------------------------------
# SMTP Credentials
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: smtp-credentials
  namespace: autolytiq
  labels:
    app.kubernetes.io/name: smtp-credentials
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: smtp-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        SMTP_HOST: '{{ .host }}'
        SMTP_PORT: '{{ .port }}'
        SMTP_USERNAME: '{{ .username }}'
        SMTP_PASSWORD: '{{ .password }}'
        SMTP_FROM_EMAIL: '{{ .from_email }}'
        SMTP_FROM_NAME: '{{ .from_name }}'
  data:
    - secretKey: host
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/smtp
        property: host
    - secretKey: port
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/smtp
        property: port
    - secretKey: username
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/smtp
        property: username
    - secretKey: password
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/smtp
        property: password
    - secretKey: from_email
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/smtp
        property: from_email
    - secretKey: from_name
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/smtp
        property: from_name
---
# -----------------------------------------------------------------------------
# Resend API Key
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: resend-credentials
  namespace: autolytiq
  labels:
    app.kubernetes.io/name: resend-credentials
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: resend-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        RESEND_API_KEY: '{{ .api_key }}'
  data:
    - secretKey: api_key
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/resend
        property: api_key
---
# -----------------------------------------------------------------------------
# External API Keys
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: external-api-credentials
  namespace: autolytiq
  labels:
    app.kubernetes.io/name: external-api-credentials
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: external-api-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        SENTRY_DSN: '{{ .sentry_dsn }}'
        DD_API_KEY: '{{ .datadog_api_key }}'
        STRIPE_SECRET_KEY: '{{ .stripe_secret_key }}'
        STRIPE_WEBHOOK_SECRET: '{{ .stripe_webhook_secret }}'
  data:
    - secretKey: sentry_dsn
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/external-apis
        property: sentry_dsn
    - secretKey: datadog_api_key
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/external-apis
        property: datadog_api_key
    - secretKey: stripe_secret_key
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/external-apis
        property: stripe_secret_key
    - secretKey: stripe_webhook_secret
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/external-apis
        property: stripe_webhook_secret
---
# -----------------------------------------------------------------------------
# Combined Autolytiq Secrets (for backward compatibility)
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: autolytiq-secrets
  namespace: autolytiq
  labels:
    app.kubernetes.io/name: autolytiq-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: autolytiq-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        DATABASE_URL: '{{ .database_url }}'
        REDIS_URL: '{{ .redis_url }}'
        JWT_SECRET: '{{ .jwt_secret }}'
        SESSION_SECRET: '{{ .session_secret }}'
        PII_ENCRYPTION_KEY: '{{ .pii_key }}'
  dataFrom:
    - extract:
        key: autolytiq/${ENVIRONMENT}/database
        property: url
        conversionStrategy: Default
        decodingStrategy: None
  data:
    - secretKey: database_url
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/database
        property: url
    - secretKey: redis_url
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/redis
        property: url
    - secretKey: jwt_secret
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/jwt
        property: secret
    - secretKey: session_secret
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/session
        property: secret
    - secretKey: pii_key
      remoteRef:
        key: autolytiq/${ENVIRONMENT}/pii-encryption
        property: key
